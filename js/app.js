const defaultConfig = {
  hero_title: "El Club del Chañar",
  hero_subtitle: "La calma también produce.",
  hero_cta: "Quiero sumarme",
  hero_location: "Lomas del Chañar · Córdoba · Argentina",
  hero_description: "Vivienda de uso compartido que explora la frontera entre hogar, taller y patio vecinal.",
  manifesto_excerpt:
    "El Club del Chañar es un espacio donde la convivencia humana y la naturaleza encuentran equilibrio. Una invitación a participar desde la calma, la creatividad y el respeto.",
  manifesto_link: "#",
  space_description:
    "El predio ocupa un lote urbano de 10 × 25 m (250 m²) en Lomas del Chañar. Combina un jardín frontal, una gran galería cubierta y una terraza abierta que podemos configurar según cada uso de la comunidad.",
  norms: [
    "Respeto por la privacidad del barrio y de quienes comparten la jornada",
    "Cuidar el equipamiento común como si fuera propio",
    "Mantener limpieza y orden al finalizar cada actividad",
    "Coordinar reservas para no sobrepasar la capacidad cómoda (50 personas)",
  ],
  story: {
    title: "Un refugio contemporáneo en 250 m²",
    description:
      "Jardín, galería y terraza se articulan como una casa abierta que conserva el alma doméstica mientras habilita usos modernos: trabajar, cocinar, contemplar o celebrar con serenidad.",
    image: "assets/story-canopy.svg",
    facts: [
      "Lote cerrado de 10 × 25 m con acceso controlado",
      "Galería techada de 8 × 15 m con asador, baños y barra",
      "Terraza superior de 120 m² con mediasombra e iluminación tenue",
    ],
  },
  principles: [
    {
      title: "Uso consciente",
      description: "Cada persona es responsable del entorno que habilita: cuida tiempos, recursos y energía.",
    },
    {
      title: "Respeto mutuo",
      description: "La convivencia se sostiene en la escucha y el silencio justo, privilegiando la calma del barrio.",
    },
    {
      title: "Comunidad cerrada",
      description: "Acceso por invitación, membresía o reserva acompañada por un miembro activo.",
    },
    {
      title: "Simplicidad funcional",
      description: "Todo elemento tiene propósito claro: bienestar, colaboración o creación.",
    },
    {
      title: "Naturaleza integrada",
      description: "El árbol, la sombra y el viento participan del diseño y regulan los ritmos diarios.",
    },
    {
      title: "Temporalidad consciente",
      description: "Trabajamos por etapas de experimentación: nada es definitivo, todo se evalúa y mejora.",
    },
  ],
  spaces_overview: [
    {
      name: "Jardín y patio de entrada",
      description: "Espacio abierto con vegetación, tránsito y recepción. Marca el ritmo de llegada con portón de madera e iluminación suave.",
      image: "assets/space-jardin.svg",
      services: [
        "Área verde 10 × 10 m para encuentros breves",
        "Portón y acceso peatonal controlado",
        "Capacidad adicional de 10 a 15 personas",
      ],
    },
    {
      name: "Galería principal",
      description: "Núcleo operativo techado y sin paredes laterales. Alberga la cocina, barra y baños para jornadas extensas.",
      image: "assets/space-taller.svg",
      services: [
        "120 m² cubiertos con sonido ambiental",
        "Asador, barra para 10 personas y dos baños",
        "24 puestos con mesas bajas y mobiliario flexible",
      ],
    },
    {
      name: "Cocina y almacén",
      description: "Local cerrado integrado a la galería con provisiones básicas para eventos, talleres culinarios o cafés comunitarios.",
      image: "assets/space-residencia.svg",
      services: [
        "Heladera exhibidora y almacenamiento seco",
        "Filtro de agua, cafetera, pava y microondas",
        "Bacha y mesadas para staging de alimentos",
      ],
    },
    {
      name: "Terraza superior",
      description: "Plataforma abierta de 8 × 15 m con barandas y mediasombra parcial; ideal para respiración guiada, proyecciones o descanso.",
      image: "assets/story-canopy.svg",
      services: [
        "Iluminación tenue y luminarias de emergencia",
        "Pisos cerámicos antideslizantes",
        "Capacidad para 20-25 personas con reposeras",
      ],
    },
  ],
  infrastructure: [
    {
      title: "Conectividad y energía",
      details: "Internet satelital estable, disyuntor diferencial y tomas IP44/IP65 para interior y terraza.",
    },
    {
      title: "Seguridad activa",
      details: "Portón controlado, cámaras con IA, extintores ABC + K, señalización fotoluminiscente.",
    },
    {
      title: "Clima y bienestar",
      details: "Ventilación cruzada, calefacción a gas, guirnaldas cálidas y sonido ambiental de baja intensidad.",
    },
    {
      title: "Higiene y apoyo",
      details: "Botiquín visible, limpieza profesional semanal, mobiliario móvil y kits de orden compartido.",
    },
  ],
  shared_use: {
    intro: "El Club funciona como una casa compartida: organizamos turnos y montajes según la cantidad de personas y la energía disponible.",
    modes: [
      {
        title: "Trabajo colaborativo",
        description: "Coworking vecinal, reuniones de proyecto y talleres que aprovechan la galería como aula abierta.",
        guides: [
          "Capacidad recomendada: 25 personas sentadas",
          "Reservar con al menos 48 h para coordinar mobiliario",
          "Internet satelital disponible en toda la galería",
        ],
      },
      {
        title: "Recreación tranquila",
        description: "Encuentros íntimos, charlas, lecturas o proyecciones al atardecer en patio o terraza.",
        guides: [
          "Patio admite 10-15 personas adicionales",
          "Uso de sonido ambiental a volumen moderado",
          "Cuidar iluminación cálida para mantener la atmósfera",
        ],
      },
      {
        title: "Bienestar y movimiento",
        description: "Yoga, respiración, stretching o funcional en la terraza o galería despejada.",
        guides: [
          "Terraza: 20 personas en movimiento / 25 con reposeras",
          "Muebles móviles para despejar circulaciones",
          "Coordinar horarios para respetar el descanso del vecindario",
        ],
      },
      {
        title: "Socialización responsable",
        description: "Asados, celebraciones pequeñas o ferias que usan cocina, barra y terraza de forma integrada.",
        guides: [
          "Capacidad total sugerida: 45-50 personas simultáneas",
          "Gestionar residuos y limpieza al finalizar",
          "Priorizar proveedores y arte local",
        ],
      },
    ],
    cta: "Cuéntanos qué tipo de encuentro imaginas y coordinamos el montaje que mejor acompañe al grupo.",
  },
  operations: {
    schedule: "Lunes a viernes · 08:00 a 20:00",
    capacity: "25 personas en galería · Hasta 45 combinando patio y terraza",
    access: "Acceso por invitación, membresía o reserva acompañada de un miembro responsable",
    channels: ["Grupo privado de Telegram", "Tablero físico en galería", "Registro digital de asistencia"],
    memberships: [
      {
        name: "Residente",
        details: "Uso regular hasta 5 días por semana · lockers personales",
        fee: "Aporte sugerido: $XX.XXX/mes",
      },
      {
        name: "Vecinal",
        details: "Reservas ocasionales por día completo",
        fee: "Aporte sugerido: $X.XXX por jornada",
      },
      {
        name: "Aliado",
        details: "Participa en proyectos específicos y apoyo operativo",
        fee: "Aporte voluntario acordado en cada ciclo",
      },
    ],
    commitments: [
      "Ruido moderado (<55 dB) y música ambiental a bajo volumen",
      "Prohibido fumar en áreas techadas",
      "Cada persona limpia y ordena antes de retirarse",
      "Asamblea mensual para decisiones colectivas",
    ],
  },
  subscription_form_url: "",
  contact_email: "clubdelchanar@gmail.com",
  location_embed: "",
};

let gallerySectionsData = [];
let galleryModalState = { sectionIndex: 0, imageIndex: 0 };
let galleryInteractionsBound = false;

async function loadConfig() {
  try {
    const response = await fetch("config.json", { cache: "no-store" });
    if (!response.ok) throw new Error("No se pudo leer config.json");
    const data = await response.json();
    // Los datos del archivo tienen prioridad sobre la configuración por defecto
    return { ...defaultConfig, ...data };
  } catch (error) {
    console.warn("Usando configuración por defecto", error);
    return defaultConfig;
  }
}

function hydrateUI(config) {
  const heroTitle = document.getElementById("hero-title");
  const heroSubtitle = document.getElementById("hero-subtitle");
  const heroCta = document.getElementById("hero-cta");
  const heroLocation = document.getElementById("hero-location");
  const heroDescription = document.getElementById("hero-description");
  const manifestoExcerpt = document.getElementById("manifesto-excerpt");
  const manifestoLink = document.getElementById("manifesto-link");
  const manifestoDetails = document.querySelector(".manifesto__details");
  const mapEmbed = document.getElementById("map-embed");
  const contactEmail = document.getElementById("contact-email");
  const clubDescription = document.querySelector(".club-description__text");
  const servicesGrid = document.getElementById("services-grid");
  const principlesGrid = document.getElementById("principles-grid");
  const infrastructureGrid = document.getElementById("infrastructure-grid");
  const sharedIntro = document.getElementById("shared-intro");
  const sharedGrid = document.getElementById("shared-use-grid");
  const sharedCta = document.getElementById("shared-use-cta");
  const operationsAccess = document.getElementById("operations-access");
  const operationsSchedule = document.getElementById("operations-schedule");
  const operationsCapacity = document.getElementById("operations-capacity");
  const operationsChannels = document.getElementById("operations-channels");
  const operationsMemberships = document.getElementById("operations-memberships");
  const operationsCommitments = document.getElementById("operations-commitments");

  heroTitle.textContent = config.hero_title;
  heroSubtitle.textContent = config.hero_subtitle;
  heroCta.textContent = config.hero_cta;
  if (heroLocation) heroLocation.textContent = config.hero_location || "";
  if (heroDescription) heroDescription.textContent = config.hero_description || "";
  manifestoExcerpt.textContent = config.manifesto_excerpt;
  manifestoLink.href = config.manifesto_link;
  
  // Actualizar detalles del manifiesto
  if (manifestoDetails && Array.isArray(config.manifesto_details) && config.manifesto_details.length) {
    manifestoDetails.innerHTML = '';
    config.manifesto_details.forEach(detail => {
      const p = document.createElement('p');
      p.textContent = detail;
      manifestoDetails.appendChild(p);
    });
  }
  if (mapEmbed && config.location_embed) {
    mapEmbed.src = config.location_embed;
  }

  contactEmail.href = `mailto:${config.contact_email}`;
  contactEmail.textContent = config.contact_email;

  // Actualizar sección del Club
  if (config.club_description && clubDescription) {
    const lead = clubDescription.querySelector('.section__lead');
    const description = clubDescription.querySelector('p:nth-of-type(2)');
    const proposalList = clubDescription.querySelector('.features__column:first-child ul');
    const principlesList = clubDescription.querySelector('.features__column:last-child ul');
    
    if (lead && config.club_description.lead) {
      lead.textContent = config.club_description.lead;
    }
    
    if (description && config.club_description.description) {
      description.textContent = config.club_description.description;
    }
    
    if (proposalList && Array.isArray(config.club_description.proposal_features)) {
      proposalList.innerHTML = '';
      config.club_description.proposal_features.forEach(feature => {
        const li = document.createElement('li');
        li.textContent = feature;
        proposalList.appendChild(li);
      });
    }
    
    if (principlesList && Array.isArray(config.club_description.ecological_principles)) {
      principlesList.innerHTML = '';
      config.club_description.ecological_principles.forEach(principle => {
        const li = document.createElement('li');
        li.textContent = principle;
        principlesList.appendChild(li);
      });
    }
    

  }

  renderServices(servicesGrid, config.spaces_overview);
  renderPrinciples(principlesGrid, config.principles);
  renderInfrastructure(infrastructureGrid, config.infrastructure);
  renderSharedUse(sharedIntro, sharedGrid, sharedCta, config.shared_use);
  renderOperations(
    {
      access: operationsAccess,
      schedule: operationsSchedule,
      capacity: operationsCapacity,
      channels: operationsChannels,
      memberships: operationsMemberships,
      commitments: operationsCommitments,
    },
    config.operations
  );
}

function setupNav() {
  const toggle = document.querySelector(".nav__toggle");
  const links = document.querySelector(".nav__links");
  const nav = document.querySelector(".nav");
  if (!toggle || !links || !nav) return;

  // Toggle del menú móvil
  toggle.addEventListener("click", () => {
    const isOpen = links.classList.toggle("is-open");
    toggle.setAttribute("aria-expanded", String(isOpen));
  });

  // Cerrar menú al hacer clic en enlaces y aplicar scroll suave
  links.querySelectorAll("a").forEach((anchor) => {
    anchor.addEventListener("click", (event) => {
      const href = anchor.getAttribute("href");
      
      // Solo procesar enlaces internos (que empiezan con #)
      if (href && href.startsWith("#")) {
        event.preventDefault();
        const target = document.querySelector(href);
        if (target) {
          // Usar el mismo scroll suave que el botón "Quiero sumarme"
          const headerHeight = 90; // Offset que coincide con scroll-margin-top
          const extraOffset = 20; // Espacio adicional para detenerse antes
          
          // Offset adicional específico para la sección de Manifiesto
          const isManifesto = target.id === 'manifesto';
          const manifestoExtraOffset = isManifesto ? 40 : 0;
          
          const targetRect = target.getBoundingClientRect();
          const targetPosition = targetRect.top + window.pageYOffset - headerHeight - extraOffset - manifestoExtraOffset;
          
          window.scrollTo({
            top: targetPosition,
            behavior: "smooth"
          });
        }
      }
      
      links.classList.remove("is-open");
      toggle.setAttribute("aria-expanded", "false");
    });
  });

  // Efecto de scroll en la navegación
  function handleScroll() {
    const scrollY = window.scrollY;
    
    // Activar navegación compacta inmediatamente
    if (scrollY > 10) {
      nav.classList.add("nav--scrolled");
    } else {
      nav.classList.remove("nav--scrolled");
    }

    // Actualizar enlace activo
    updateActiveNavLink();
  }

  // Actualizar enlace activo en navegación
  function updateActiveNavLink() {
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav__links a');
    
    let current = '';
    const baseOffset = 120; // Offset base para mejor precisión
    
    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.clientHeight;
      const sectionId = section.getAttribute('id');
      
      // Offset adicional para la sección de Manifiesto
      const isManifesto = sectionId === 'manifesto';
      const sectionOffset = isManifesto ? 40 : 0;
      const scrollY = window.scrollY + baseOffset + sectionOffset;

      if (scrollY >= sectionTop && scrollY < sectionTop + sectionHeight) {
        current = sectionId;
      }
    });

    navLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('href') === `#${current}`) {
        link.classList.add('active');
      }
    });
  }

  window.addEventListener("scroll", handleScroll);
  handleScroll(); // Ejecutar al cargar
}

function renderServices(container, spaces = []) {
  if (!container) return;
  container.innerHTML = "";
  if (!Array.isArray(spaces) || !spaces.length) {
    const placeholder = document.createElement("p");
    placeholder.textContent = "Pronto detallaremos los espacios disponibles.";
    container.appendChild(placeholder);
    return;
  }

  spaces.forEach((space, index) => {
    const card = document.createElement("article");
    card.className = "service-card";
    card.style.animationDelay = `${index * 0.1}s`;

    const media = document.createElement("figure");
    media.className = "service-card__media";
    media.style.backgroundImage = `url('${space.image || "assets/space-taller.svg"}')`;
    media.setAttribute("role", "presentation");

    const body = document.createElement("div");
    body.className = "service-card__body";

    const title = document.createElement("h3");
    title.textContent = space.name;

    const description = document.createElement("p");
    description.textContent = space.description;

    body.append(title, description);

    if (Array.isArray(space.services) && space.services.length) {
      const list = document.createElement("ul");
      space.services.forEach((service) => {
        const li = document.createElement("li");
        li.textContent = service;
        list.appendChild(li);
      });
      body.appendChild(list);
    }

    card.append(media, body);
    container.appendChild(card);
  });
}

function renderSharedUse(introEl, grid, ctaEl, shared = {}) {
  if (introEl && shared.intro) {
    introEl.textContent = shared.intro;
  }

  if (ctaEl && shared.cta) {
    ctaEl.textContent = shared.cta;
  }

  if (!grid) return;
  grid.innerHTML = "";
  if (!Array.isArray(shared.modes) || !shared.modes.length) {
    const placeholder = document.createElement("p");
    placeholder.textContent = "Definiremos nuevas modalidades pronto.";
    grid.appendChild(placeholder);
    return;
  }

  shared.modes.forEach((mode) => {
    const card = document.createElement("article");
    card.className = "shared-card";

    const title = document.createElement("h3");
    title.textContent = mode.title;

    const description = document.createElement("p");
    description.textContent = mode.description;

    card.append(title, description);

    if (Array.isArray(mode.guides) && mode.guides.length) {
      const list = document.createElement("ul");
      mode.guides.forEach((guide) => {
        const li = document.createElement("li");
        li.textContent = guide;
        list.appendChild(li);
      });
      card.appendChild(list);
    }

    grid.appendChild(card);
  });
}

function renderPrinciples(container, principles = []) {
  if (!container) return;
  container.innerHTML = "";
  if (!Array.isArray(principles) || !principles.length) {
    container.textContent = "Pronto publicaremos nuestros principios.";
    return;
  }

  principles.forEach((principle, index) => {
    const card = document.createElement("article");
    card.className = "principle-card";
    card.style.animationDelay = `${index * 0.1}s`;
    const badge = document.createElement("span");
    badge.className = "principle-card__badge";
    badge.textContent = `0${index + 1}`;
    const title = document.createElement("h3");
    title.textContent = principle.title;
    const description = document.createElement("p");
    description.textContent = principle.description;
    card.append(badge, title, description);
    container.appendChild(card);
  });
}

function renderInfrastructure(container, items = []) {
  if (!container) return;
  container.innerHTML = "";
  if (!Array.isArray(items) || !items.length) {
    container.textContent = "Infraestructura en actualización.";
    return;
  }

  items.forEach((item) => {
    const card = document.createElement("article");
    card.className = "infrastructure-card";
    const title = document.createElement("h3");
    title.textContent = item.title;
    const details = document.createElement("p");
    details.textContent = item.details;
    card.append(title, details);
    container.appendChild(card);
  });
}

function renderGallery(container, sections = []) {
  if (!container) return;
  container.innerHTML = "";

  if (!Array.isArray(sections) || !sections.length) {
    const placeholder = document.createElement("p");
    placeholder.innerHTML = "Aún no hay imágenes disponibles. Agrega archivos en <code>assets/gallery/</code> y ejecuta <code>npm run build:gallery</code> antes de publicar.";
    container.appendChild(placeholder);
    return;
  }

  sections.forEach((section, sectionIndex) => {
    const card = document.createElement("article");
    card.className = "gallery__section";
    card.dataset.gallerySection = sectionIndex;

    const header = document.createElement("header");
    const title = document.createElement("h3");
    title.textContent = section.name;
    const count = document.createElement("span");
    count.className = "gallery__count";
    const images = Array.isArray(section.images) ? section.images : [];
    count.textContent = `${images.length} imagen${images.length === 1 ? "" : "es"}`;
    header.append(title, count);
    card.appendChild(header);

    if (section.description) {
      const description = document.createElement("p");
      description.textContent = section.description;
      card.appendChild(description);
    }

    const toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "gallery__toggle";
    toggle.dataset.galleryToggle = sectionIndex;
    toggle.textContent = "Ver álbum";
    card.appendChild(toggle);

    if (images.length) {
      const grid = document.createElement("div");
      grid.className = "gallery__grid";
      grid.dataset.galleryId = section.slug || `gallery-${sectionIndex}`;
      images.forEach((image, index) => {
        const fig = document.createElement("figure");
        fig.className = "gallery__item";

        const button = document.createElement("button");
        button.type = "button";
        button.className = "gallery__media-trigger";
        button.dataset.galleryTrigger = "true";
        button.dataset.sectionIndex = String(sectionIndex);
        button.dataset.imageIndex = String(index);
        button.dataset.mediaType = image.type || "image";

        if ((image.type || "image") === "video") {
          const video = document.createElement("video");
          video.src = image.src;
          video.muted = true;
          video.loop = true;
          video.preload = "metadata";
          video.setAttribute("playsinline", "");
          video.setAttribute("aria-hidden", "true");
          button.appendChild(video);
        } else {
          const img = document.createElement("img");
          img.src = image.src;
          img.alt = image.alt || `${section.name} · ${image.label || image.filename || `Imagen ${index + 1}`}`;
          img.loading = "lazy";
          button.appendChild(img);
        }

        fig.appendChild(button);

        const caption = document.createElement("span");
        caption.textContent = image.label || image.filename || `Imagen ${index + 1}`;
        fig.appendChild(caption);
        grid.appendChild(fig);
      });
      card.appendChild(grid);
    }

    container.appendChild(card);
  });
}

async function loadGalleryManifest() {
  if (window.__GALLERY_MANIFEST__ && Array.isArray(window.__GALLERY_MANIFEST__.sections)) {
    return window.__GALLERY_MANIFEST__.sections;
  }
  try {
    const response = await fetch("gallery-manifest.json", { cache: "no-store" });
    if (!response.ok) throw new Error("No se encontró gallery-manifest.json");
    const data = await response.json();
    return Array.isArray(data.sections) ? data.sections : [];
  } catch (error) {
    console.warn("No pudimos cargar el manifiesto de galería", error);
    return [];
  }
}

function setupGalleryModalInteractions() {
  if (galleryInteractionsBound) return;
  galleryInteractionsBound = true;

  document.addEventListener("click", (event) => {
    const toggle = event.target.closest("[data-gallery-toggle]");
    if (toggle) {
      event.preventDefault();
      const sectionIndex = Number(toggle.dataset.galleryToggle || 0);
      toggleGallerySection(sectionIndex);
      return;
    }

    const closeTrigger = event.target.closest("[data-gallery-close]");
    if (closeTrigger) {
      event.preventDefault();
      closeGalleryModal();
      return;
    }

    const prevTrigger = event.target.closest("[data-gallery-prev]");
    if (prevTrigger) {
      event.preventDefault();
      navigateGallery(-1);
      return;
    }

    const nextTrigger = event.target.closest("[data-gallery-next]");
    if (nextTrigger) {
      event.preventDefault();
      navigateGallery(1);
      return;
    }

    const imageTrigger = event.target.closest("[data-gallery-trigger]");
    if (imageTrigger) {
      event.preventDefault();
      const sectionIndex = Number(imageTrigger.dataset.sectionIndex || 0);
      const imageIndex = Number(imageTrigger.dataset.imageIndex || 0);
      openGalleryModal(sectionIndex, imageIndex);
    }
  });

  document.addEventListener("keydown", (event) => {
    if (isGalleryModalOpen()) {
      if (event.key === "Escape") {
        closeGalleryModal();
      } else if (event.key === "ArrowRight") {
        navigateGallery(1);
      } else if (event.key === "ArrowLeft") {
        navigateGallery(-1);
      }
    }
  });
}

function openGalleryModal(sectionIndex, imageIndex) {
  const modal = document.getElementById("gallery-modal");
  if (!modal || !gallerySectionsData.length) return;
  galleryModalState = {
    sectionIndex: clampGalleryIndex(sectionIndex),
    imageIndex: clampImageIndex(sectionIndex, imageIndex),
  };
  updateGalleryModalMedia();
  modal.classList.add("is-open");
  modal.removeAttribute("hidden");
  document.body.style.overflow = "hidden";
}

function closeGalleryModal() {
  const modal = document.getElementById("gallery-modal");
  if (!modal) return;
  const videoEl = document.getElementById("gallery-modal-video");
  if (videoEl) {
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.load();
  }
  const imgEl = document.getElementById("gallery-modal-image");
  if (imgEl) {
    imgEl.removeAttribute("src");
  }
  modal.classList.remove("is-open");
  modal.setAttribute("hidden", "hidden");
  document.body.style.overflow = "";
}

function navigateGallery(step) {
  if (!gallerySectionsData.length) return;
  const section = gallerySectionsData[galleryModalState.sectionIndex];
  if (!section || !Array.isArray(section.images) || !section.images.length) return;

  let newIndex = galleryModalState.imageIndex + step;
  if (newIndex < 0) {
    newIndex = section.images.length - 1;
  } else if (newIndex >= section.images.length) {
    newIndex = 0;
  }
  galleryModalState.imageIndex = newIndex;
  updateGalleryModalMedia();
}

function clampGalleryIndex(index) {
  if (!gallerySectionsData.length) return 0;
  if (index < 0) return 0;
  if (index >= gallerySectionsData.length) return gallerySectionsData.length - 1;
  return index;
}

function clampImageIndex(sectionIndex, imageIndex) {
  const section = gallerySectionsData[sectionIndex];
  if (!section || !section.images || !section.images.length) return 0;
  if (imageIndex < 0) return 0;
  if (imageIndex >= section.images.length) return section.images.length - 1;
  return imageIndex;
}

function updateGalleryModalMedia() {
  const modal = document.getElementById("gallery-modal");
  const imgEl = document.getElementById("gallery-modal-image");
  const videoEl = document.getElementById("gallery-modal-video");
  const captionEl = document.getElementById("gallery-modal-caption");
  const section = gallerySectionsData[galleryModalState.sectionIndex];
  if (!modal || !imgEl || !videoEl || !captionEl || !section) return;
  const item = section.images[galleryModalState.imageIndex];
  if (!item) return;

  const isVideo = item.type === "video";
  if (isVideo) {
    imgEl.hidden = true;
    imgEl.removeAttribute("src");
    videoEl.hidden = false;
    videoEl.src = item.src;
    videoEl.setAttribute("aria-label", item.label || item.filename || "Video de galería");
    videoEl.load();
    videoEl.play().catch(() => {});
  } else {
    videoEl.pause();
    videoEl.hidden = true;
    videoEl.removeAttribute("src");
    videoEl.load();
    imgEl.hidden = false;
    imgEl.src = item.src;
    imgEl.alt = item.alt || `${section.name} · ${item.label || item.filename || "Imagen"}`;
  }

  captionEl.textContent = `${section.name} · ${item.label || item.filename || ""}`;
}

function isGalleryModalOpen() {
  const modal = document.getElementById("gallery-modal");
  return modal && modal.classList.contains("is-open");
}

function toggleGallerySection(sectionIndex) {
  const sectionCard = document.querySelector(`[data-gallery-section="${sectionIndex}"]`);
  if (!sectionCard) return;
  const toggleButton = sectionCard.querySelector("[data-gallery-toggle]");
  const isExpanded = sectionCard.classList.toggle("is-expanded");
  if (toggleButton) {
    toggleButton.textContent = isExpanded ? "Ocultar álbum" : "Ver álbum";
  }
}

function renderOperations(elements, operations = {}) {
  if (!operations) return;

  if (elements.access && operations.access) {
    elements.access.textContent = operations.access;
  }
  if (elements.schedule && operations.schedule) {
    elements.schedule.textContent = operations.schedule;
  }
  if (elements.capacity && operations.capacity) {
    elements.capacity.textContent = operations.capacity;
  }
  if (elements.channels) {
    elements.channels.innerHTML = "";
    if (Array.isArray(operations.channels) && operations.channels.length) {
      operations.channels.forEach((channel) => {
        const li = document.createElement("li");
        li.textContent = channel;
        elements.channels.appendChild(li);
      });
    }
  }
  if (elements.memberships) {
    elements.memberships.innerHTML = "";
    if (Array.isArray(operations.memberships) && operations.memberships.length) {
      operations.memberships.forEach((membership) => {
        const card = document.createElement("article");
        card.className = "membership-card";
        const title = document.createElement("h3");
        title.textContent = membership.name;
        const details = document.createElement("p");
        details.textContent = membership.details;
        const fee = document.createElement("small");
        fee.textContent = membership.fee;
        card.append(title, details, fee);
        elements.memberships.appendChild(card);
      });
    }
  }
  if (elements.commitments) {
    elements.commitments.innerHTML = "";
    if (Array.isArray(operations.commitments) && operations.commitments.length) {
      operations.commitments.forEach((commitment) => {
        const li = document.createElement("li");
        li.textContent = commitment;
        elements.commitments.appendChild(li);
      });
    }
  }
}

function setupSmoothScroll() {
  document.addEventListener("click", (event) => {
    const trigger = event.target.closest("[data-scroll]");
    if (!trigger) return;
    const target = document.querySelector(trigger.dataset.scroll);
    if (!target) return;
    event.preventDefault();
    
    // Calcular offset usando getBoundingClientRect para mayor precisión
    const headerHeight = 90; // Offset que coincide con scroll-margin-top
    const extraOffset = 20; // Espacio adicional para detenerse antes
    
    // Offset adicional específico para la sección de Manifiesto
    const isManifesto = target.id === 'manifesto';
    const manifestoExtraOffset = isManifesto ? 40 : 0;
    
    const targetRect = target.getBoundingClientRect();
    const targetPosition = targetRect.top + window.pageYOffset - headerHeight - extraOffset - manifestoExtraOffset;
    
    window.scrollTo({
      top: targetPosition,
      behavior: "smooth"
    });
  });
}

function setupSubscriptionLink(config) {
  const link = document.querySelector("[data-subscribe-link]");
  if (!link) return;

  const currentHref = link.getAttribute("href") || "";

  if (config.subscription_form_url) {
    link.href = config.subscription_form_url;
    return;
  }

  if (!currentHref || currentHref.startsWith("#")) {
    link.removeAttribute("href");
    link.setAttribute("aria-disabled", "true");
    link.textContent = "Formulario no disponible";
  }
}

function setYear() {
  const yearEl = document.getElementById("year");
  if (yearEl) {
    yearEl.textContent = new Date().getFullYear();
  }
}

(async function init() {
  try {
    setYear();
    setupNav();
    setupSmoothScroll();
    const config = await loadConfig();
    hydrateUI(config);
    setupSubscriptionLink(config);
    const sections = await loadGalleryManifest();
    gallerySectionsData = sections;
    const galleryContainer = document.getElementById("gallery-sections");
    renderGallery(galleryContainer, sections);
    setupGalleryModalInteractions();
    setupGalleryModalInteractions();
  } catch (error) {
    console.error("Error inicializando la página", error);
  }
})();
